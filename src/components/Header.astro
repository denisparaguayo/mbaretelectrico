---
import OrderCountBadge from './OrderCountBadge.tsx';

const siteName = import.meta.env.PUBLIC_SITE_NAME ?? 'Mbarete';
const desc = import.meta.env.PUBLIC_SITE_DESCRIPTOR ?? 'El√©ctrico';

const pathname = Astro.url.pathname;

const nav = [
	{ href: '/catalogo', label: 'Cat√°logo' },
	{ href: '/pedido', label: 'Pedido' },
	{ href: '/envios', label: 'Env√≠os' },
];

// WhatsApp
const waPhone = import.meta.env.PUBLIC_WHATSAPP_PHONE ?? '';
const waText = 'Hola! Quiero hacer un pedido üôÇ';
const waHref = waPhone
	? `https://wa.me/${waPhone}?text=${encodeURIComponent(waText)}`
	: '#';

function isActive(href: string) {
	if (href === '/') return pathname === '/';
	return pathname === href || pathname.startsWith(href + '/');
}
---

<header
	class="sticky top-0 z-[60] border-b border-(--border) bg-white/85 backdrop-blur-[10px]">
	<div
		class="mx-auto flex max-w-[1100px] items-center justify-between gap-3 px-4 py-3 sm:px-6">
		<!-- Brand -->
		<a href="/" class="flex items-center gap-3" aria-label="Inicio">
			<img
				src="/img/logo2.png"
				alt="Mbarete"
				class="h-8 w-auto rounded-(--r-sm)"
			/>
		</a>

		<!-- Nav desktop -->
		<nav
			class="hidden items-center gap-1.5 md:flex"
			aria-label="Navegaci√≥n principal">
			{
				nav.map((item) => {
					const active = isActive(item.href);
					return (
						<a
							href={item.href}
							class={[
								'relative inline-flex items-center gap-2 rounded-full px-3.5 py-2 text-[13px] font-extrabold transition',
								active
									? 'bg-(--brand) text-(--brand-contrast) shadow-(--shadow)'
									: 'text-(--text) hover:bg-(--muted)',
							].join(' ')}>
							{item.label}
							{item.href === '/pedido' ? (
								<span class="translate-y-[1px]">
									<OrderCountBadge client:load />
								</span>
							) : null}
						</a>
					);
				})
			}
		</nav>

		<!-- Actions -->
		<div class="flex items-center gap-2">
			<a
				href={waHref}
				target="_blank"
				rel="noreferrer"
				class="hidden md:inline-flex items-center justify-center rounded-full border border-(--accent-contrast) bg-(--surface) px-3.5 py-2 text-[13px] font-black text-(--text) transition hover:-translate-y-[1px] hover:shadow-(--shadow)">
				WhatsApp
			</a>

			<a
				href="/pedido"
				class="hidden md:inline-flex items-center justify-center gap-2
			rounded-(--r-md)
			bg-(--logo-orange)
			text-white
			px-4 py-2
			text-[13px] font-black
			shadow-sm
			transition
			hover:brightness-95
			active:scale-[0.98]">
				Mi pedido
				<OrderCountBadge client:load />
			</a>

			<button
				id="menuBtn"
				type="button"
				aria-label="Abrir men√∫"
				class="inline-flex items-center gap-2 rounded-full border border-(--border) bg-(--surface) px-3.5 py-2 text-[13px] font-black text-(--text) md:hidden">
				Men√∫
				<span class="inline-flex items-center">
					<OrderCountBadge client:load />
				</span>
			</button>
		</div>
	</div>
</header>

<!-- Drawer mobile -->
<div
	id="drawer"
	class="fixed inset-0 z-80 hidden bg-black/35"
	aria-hidden="true">
	<div
		class="absolute right-0 top-0 flex h-full w-[min(86vw,360px)] flex-col gap-3 border-l border-(--border) bg-(--surface) p-4"
		role="dialog"
		aria-label="Men√∫">
		<div
			class="flex items-center justify-between gap-2 border-b border-(--border) pb-3">
			<div class="leading-tight">
				<div class="text-[16px] font-black text-(--text)">{siteName}</div>
				<div class="mt-1 text-[12.5px] font-semibold text-(--text3)">
					Compr√° f√°cil y recib√≠ en tu casa.
				</div>
			</div>
			<button
				id="closeBtn"
				type="button"
				aria-label="Cerrar men√∫"
				class="rounded-full border border-(--border) bg-(--surface) px-3 py-2 font-black text-(--text)">
				√ó
			</button>
		</div>

		<div class="grid gap-2">
			<a
				class="flex items-center justify-between rounded-(--r-lg) border border-(--border) bg-(--surface) px-3 py-3 font-black text-(--text) hover:bg-(--muted)"
				href="/catalogo">
				Cat√°logo <span class="font-extrabold text-(--text3)">‚Üí</span>
			</a>

			<a
				class="flex items-center justify-between rounded-(--r-lg) border border-(--border) bg-(--surface) px-3 py-3 font-black text-(--text) hover:bg-(--muted)"
				href="/pedido">
				<span>Pedido</span>
				<span class="inline-flex items-center gap-2">
					<OrderCountBadge client:load />
					<span class="font-extrabold text-(--text3)">‚Üí</span>
				</span>
			</a>

			<a
				class="flex items-center justify-between rounded-(--r-lg) border border-(--border) bg-(--surface) px-3 py-3 font-black text-(--text) hover:bg-(--muted)"
				href="/envios">
				Env√≠os <span class="font-extrabold text-(--text3)">‚Üí</span>
			</a>
		</div>

		<a
			class="mt-auto inline-flex items-center justify-center rounded-(--r-lg) bg-(--brand) px-3 py-3 font-black text-(--brand-contrast) hover:shadow-(--shadow)"
			href={waHref}
			target="_blank"
			rel="noreferrer">
			Escribir por WhatsApp
		</a>
	</div>
</div>

<script>
	const btn = document.getElementById('menuBtn');
	const drawer = document.getElementById('drawer');
	const closeBtn = document.getElementById('closeBtn');

	function openDrawer() {
		drawer.classList.remove('hidden');
		drawer.setAttribute('aria-hidden', 'false');
		document.body.style.overflow = 'hidden';
	}

	function closeDrawer() {
		drawer.classList.add('hidden');
		drawer.setAttribute('aria-hidden', 'true');
		document.body.style.overflow = '';
	}

	btn?.addEventListener('click', openDrawer);
	closeBtn?.addEventListener('click', closeDrawer);

	drawer?.addEventListener('click', (e) => {
		if (e.target === drawer) closeDrawer();
	});

	window.addEventListener('keydown', (e) => {
		if (e.key === 'Escape') closeDrawer();
	});
</script>
