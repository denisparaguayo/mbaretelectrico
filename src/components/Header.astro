---
import OrderCountBadge from './OrderCountBadge.tsx';

const siteName = import.meta.env.PUBLIC_SITE_NAME ?? 'Mbarete';
const desc = import.meta.env.PUBLIC_SITE_DESCRIPTOR ?? 'Electrico';

// Para marcar link activo
const pathname = Astro.url.pathname;

const nav = [
	{ href: '/catalogo', label: 'Cat√°logo' },
	{ href: '/pedido', label: 'Pedido' },
	{ href: '/envios', label: 'Informaci√≥n de entrega' },
];

// WhatsApp
const waPhone = import.meta.env.PUBLIC_WHATSAPP_PHONE ?? '';
const waText = 'Hola! Quiero hacer un pedido üôÇ';
const waHref = waPhone
	? `https://wa.me/${waPhone}?text=${encodeURIComponent(waText)}`
	: '#';

function isActive(href) {
	if (href === '/') return pathname === '/';
	return pathname === href || pathname.startsWith(href + '/');
}
---

<style>
	.header-wrap {
		position: sticky;
		top: 0;
		z-index: 60;
		background: rgba(255, 255, 255, 0.85);
		backdrop-filter: blur(10px);
		border-bottom: 1px solid #eee;
	}

	.header {
		max-width: 1100px;
		margin: 0 auto;
		padding: 14px 20px;
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 12px;
	}

	.brand {
		display: flex;
		flex-direction: column;
		text-decoration: none;
		color: #111;
		line-height: 1.05;
	}
	.brand .name {
		font-weight: 900;
		letter-spacing: -0.2px;
		font-size: 18px;
	}
	.brand .desc {
		margin-top: 3px;
		font-size: 12.5px;
		color: #666;
		font-weight: 600;
	}

	.nav {
		display: flex;
		align-items: center;
		gap: 8px;
	}

	.nav a {
		text-decoration: none;
		color: #222;
		font-weight: 800;
		font-size: 13px;
		padding: 10px 12px;
		border-radius: 999px;
		border: 1px solid transparent;
		transition:
			background 0.15s ease,
			border-color 0.15s ease;
		display: inline-flex;
		align-items: center;
		gap: 8px;
	}

	.nav a:hover {
		background: #f6f6f6;
		border-color: #eee;
	}

	.nav a.active {
		background: #111;
		color: #fff;
		border-color: #111;
	}

	.right {
		display: flex;
		align-items: center;
		gap: 10px;
	}

	.btn-wa {
		display: inline-flex;
		align-items: center;
		gap: 8px;
		text-decoration: none;
		padding: 10px 12px;
		border-radius: 999px;
		border: 1px solid #e9e9e9;
		background: #fff;
		color: #111;
		font-weight: 900;
		font-size: 13px;
		transition:
			transform 0.15s ease,
			box-shadow 0.15s ease;
	}
	.btn-wa:hover {
		box-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
		transform: translateY(-1px);
	}

	.menu-btn {
		display: none;
		border: 1px solid #e9e9e9;
		background: #fff;
		padding: 10px 12px;
		border-radius: 999px;
		font-weight: 900;
		cursor: pointer;
	}

	/* Mobile */
	@media (max-width: 820px) {
		.nav {
			display: none;
		}
		.btn-wa {
			display: none;
		}
		.menu-btn {
			display: inline-flex;
			align-items: center;
			gap: 8px;
		}
	}

	/* Drawer */
	.drawer {
		position: fixed;
		inset: 0;
		background: rgba(0, 0, 0, 0.35);
		display: none;
		z-index: 80;
	}
	.drawer.open {
		display: block;
	}

	.panel {
		position: absolute;
		top: 0;
		right: 0;
		width: min(86vw, 360px);
		height: 100%;
		background: #fff;
		border-left: 1px solid #eee;
		padding: 16px;
		display: flex;
		flex-direction: column;
		gap: 10px;
	}

	.panel-top {
		display: flex;
		justify-content: space-between;
		align-items: center;
		gap: 10px;
		padding-bottom: 10px;
		border-bottom: 1px solid #eee;
	}

	.close-btn {
		border: 1px solid #eee;
		background: #fff;
		padding: 10px 12px;
		border-radius: 999px;
		cursor: pointer;
		font-weight: 900;
	}

	.panel a {
		text-decoration: none;
		color: #111;
		font-weight: 900;
		padding: 12px 12px;
		border-radius: 14px;
		border: 1px solid #eee;
		background: #fff;
		display: flex;
		justify-content: space-between;
		align-items: center;
	}

	.panel a:active {
		transform: scale(0.99);
	}

	.panel .wa-mobile {
		margin-top: auto;
		border: 1px solid #111;
		background: #111;
		color: #fff;
		justify-content: center;
	}

	.muted {
		color: #666;
		font-size: 12.5px;
		line-height: 1.4;
	}
</style>

<div class="header-wrap">
	<div class="header">
		<a class="brand" href="/">
			<img src="/img/logo2.png" alt="Mbarete El√©ctrico" style="height:32px;" />
		</a>

		<nav class="nav" aria-label="Navegaci√≥n principal">
			{
				nav.map((item) => (
					<a href={item.href} class={isActive(item.href) ? 'active' : ''}>
						{item.label}
						{item.href === '/pedido' ? <OrderCountBadge client:load /> : null}
					</a>
				))
			}
		</nav>

		<div class="right">
			<a class="btn-wa" href={waHref} target="_blank" rel="noreferrer">
				WhatsApp
			</a>

			<button
				class="menu-btn"
				id="menuBtn"
				type="button"
				aria-label="Abrir men√∫">
				Men√∫
				<span
					style="display:inline-flex;align-items:center;justify-content:center;">
					<OrderCountBadge client:load />
				</span>
			</button>
		</div>
	</div>
</div>

<!-- Drawer mobile -->
<div class="drawer" id="drawer" aria-hidden="true">
	<div class="panel" role="dialog" aria-label="Men√∫">
		<div class="panel-top">
			<div>
				<div style="font-weight:900;font-size:16px;line-height:1;">
					{siteName}
				</div>
				<div class="muted">Compr√° f√°cil y recib√≠ en tu casa.</div>
			</div>
			<button
				class="close-btn"
				id="closeBtn"
				type="button"
				aria-label="Cerrar men√∫">√ó</button
			>
		</div>

		<a href="/catalogo">
			Cat√°logo
			<span style="color:#666;font-weight:800;">‚Üí</span>
		</a>

		<a href="/pedido">
			Pedido
			<span style="display:inline-flex;align-items:center;gap:8px;">
				<OrderCountBadge client:load />
				<span style="color:#666;font-weight:800;">‚Üí</span>
			</span>
		</a>

		<a href="/envios">
			Informaci√≥n de entrega
			<span style="color:#666;font-weight:800;">‚Üí</span>
		</a>

		<a class="wa-mobile" href={waHref} target="_blank" rel="noreferrer">
			Escribir por WhatsApp
		</a>
	</div>
</div>

<script>
	const btn = document.getElementById('menuBtn');
	const drawer = document.getElementById('drawer');
	const closeBtn = document.getElementById('closeBtn');

	function openDrawer() {
		drawer.classList.add('open');
		drawer.setAttribute('aria-hidden', 'false');
		document.body.style.overflow = 'hidden';
	}

	function closeDrawer() {
		drawer.classList.remove('open');
		drawer.setAttribute('aria-hidden', 'true');
		document.body.style.overflow = '';
	}

	btn?.addEventListener('click', openDrawer);
	closeBtn?.addEventListener('click', closeDrawer);

	// Click fuera del panel
	drawer?.addEventListener('click', (e) => {
		if (e.target === drawer) closeDrawer();
	});

	// Escape
	window.addEventListener('keydown', (e) => {
		if (e.key === 'Escape') closeDrawer();
	});
</script>
