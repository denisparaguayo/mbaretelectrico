---
import BaseLayout from "../layouts/BaseLayout.astro";
import CatalogBrowser from "../components/CatalogBrowser.tsx";
import { getCollection } from "astro:content";
import precios from "../data/precios.json";

// üîπ Cargar productos y categor√≠as
const productos = await getCollection("productos");
const categorias = await getCollection("categorias");

// üîπ Detectar categor√≠a desde URL
const selectedCat = Astro.url.searchParams.get("cat") || "all";

// üîπ Categor√≠a actual (si existe)
const categoriaActual =
  selectedCat !== "all"
    ? categorias.find((c) => c.slug === selectedCat)
    : null;

// üîπ SEO din√°mico
const pageTitle = categoriaActual?.data?.title
  ? `${categoriaActual.data.title} | Mbarete El√©ctrico`
  : "Cat√°logo | Mbarete El√©ctrico";

const pageDescription = categoriaActual?.data?.description
  ? categoriaActual.data.description
  : "Cat√°logo de materiales el√©ctricos y herramientas con entrega en Asunci√≥n y Central.";

// üîπ Canonical (Netlify o dominio)
const SITE_URL =
  (import.meta.env.PUBLIC_SITE_URL ??
    import.meta.env.DEPLOY_PRIME_URL ??
    import.meta.env.URL ??
    "").replace(/\/$/, "");

const canonical = SITE_URL
  ? `${SITE_URL}${Astro.url.pathname}${Astro.url.search}`
  : Astro.url.href;

// üîπ Serializar productos y aplicar precios desde JSON
const products = productos.map((p) => {
  const codigo = p.data.codigoProducto;
  const precio = (precios as any)[codigo] ?? p.data.precioPublico ?? 0;

  return {
    slug: p.slug,
    nombre: p.data.nombre,
    marca: p.data.marca,
    categoria: p.data.categoria,
    codigoProducto: codigo,
    precioPublico: precio,
    tipoVenta: p.data.tipoVenta,
    descripcionCorta: p.data.descripcionCorta,
    imagen: p.data.imagen,
    tags: p.data.tags,
  };
});

// üîπ Chips categor√≠as (ids deben coincidir con categoria del producto)
const categories = [
  { id: "all", label: "Todos" },
  { id: "iluminacion", label: "Iluminaci√≥n" },
  { id: "cables", label: "Cables" },
  { id: "llaves-y-tomas", label: "Llaves y tomas" },
  { id: "herramientas-manuales", label: "Herramientas manuales" },
  { id: "herramientas-electricas", label: "Herramientas el√©ctricas" },
  { id: "accesorios", label: "Accesorios" },
];

// üîπ JSON-LD CollectionPage (solo si hay categor√≠a)
const collectionJsonLd = categoriaActual
  ? {
      "@context": "https://schema.org",
      "@type": "CollectionPage",
      name: categoriaActual.data.title,
      description: categoriaActual.data.description,
      url: canonical,
    }
  : {
      "@context": "https://schema.org",
      "@type": "CollectionPage",
      name: "Cat√°logo | Mbarete El√©ctrico",
      description: pageDescription,
      url: canonical,
    };
---

<BaseLayout title={pageTitle} description={pageDescription} canonical={canonical}>
  <script type="application/ld+json">
    {JSON.stringify(collectionJsonLd)}
  </script>

  <!-- Header de p√°gina -->
  {categoriaActual ? (
    <section class="mb-5 rounded-(--r-xl) border border-(--border) bg-(--surface) p-5 sm:p-6 shadow-(--shadow)">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h1 class="m-0 text-2xl sm:text-3xl font-black tracking-tight text-(--text)">
            {categoriaActual.data.title}
          </h1>
          <p class="mt-2 text-[14px] sm:text-[15px] leading-relaxed text-(--text2) max-w-[820px]">
            {categoriaActual.data.description}
          </p>
        </div>

        <a
          href="/pedido"
          class="inline-flex items-center justify-center rounded-(--r-md) bg-(--logo-orange) text-white px-4 py-2 text-[13px] font-black shadow-sm transition hover:brightness-95 active:scale-[0.98]"
        >
          Mi pedido
        </a>
      </div>

      <!-- contenido SEO largo (MD) -->
      <div class="prose prose-sm sm:prose-base mt-4 max-w-none prose-headings:font-black prose-p:text-(--text2)">
        <div set:html={categoriaActual.body} />
      </div>
    </section>
  ) : (
    <section class="mb-5 rounded-(--r-xl) border border-(--border) bg-(--surface) p-5 sm:p-6 shadow-(--shadow)">
      <div class="flex flex-wrap items-end justify-between gap-3">
        <div>
          <h1 class="m-0 text-2xl sm:text-3xl font-black tracking-tight text-(--text)">
            Cat√°logo
          </h1>
          <p class="mt-2 text-[14px] sm:text-[15px] leading-relaxed text-(--text2) max-w-[820px]">
            Busc√°, agreg√° al pedido y envi√° todo por WhatsApp en un solo mensaje.
          </p>
        </div>

        <div class="flex gap-2">
          <a
            href="/pedido"
            class="inline-flex items-center justify-center rounded-(--r-md) bg-(--logo-orange) text-white px-4 py-2 text-[13px] font-black shadow-sm transition hover:brightness-95 active:scale-[0.98]"
          >
            Mi pedido
          </a>
        </div>
      </div>

      
    </section>
  )}

  <!-- Browser -->
  <CatalogBrowser
    client:load
    products={products}
    categories={categories}
    initialCategory={selectedCat}
  />
</BaseLayout>
