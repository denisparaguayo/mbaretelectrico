---
import BaseLayout from "../../layouts/BaseLayout.astro";
import AddToOrderButton from "../../components/AddToOrderButton.tsx";
import { formatGs } from "../../lib/money";
import { getCollection } from "astro:content";
import precios from "../../data/precios.json";

export async function getStaticPaths() {
  const productos = await getCollection("productos");

  return productos.map((p) => ({
    params: { slug: p.slug },
    props: { producto: p },
  }));
}

const { producto } = Astro.props;

// üîπ Precio din√°mico desde JSON
const codigo = producto.data.codigoProducto;
const precioPublico =
  precios[codigo] ?? producto.data.precioPublico ?? 0;

// üîπ SEO
const SITE_URL =
  (import.meta.env.PUBLIC_SITE_URL ??
    import.meta.env.DEPLOY_PRIME_URL ??
    import.meta.env.URL ??
    "").replace(/\/$/, "");

const canonical = SITE_URL
  ? `${SITE_URL}/p/${producto.slug}`
  : Astro.url.href;

const title = `${producto.data.nombre} | Mbarete El√©ctrico`;
const description =
  `${producto.data.descripcionCorta} Entrega en Asunci√≥n y Central.`;

const image = producto.data.imagen ?? "/img/og-default.jpg";

const productJsonLd = {
  "@context": "https://schema.org",
  "@type": "Product",
  name: producto.data.nombre,
  sku: codigo,
  description: producto.data.descripcionCorta,
  image: image,
  url: canonical,
  brand: producto.data.marca
    ? { "@type": "Brand", name: producto.data.marca }
    : undefined,
  offers: {
    "@type": "Offer",
    priceCurrency: "PYG",
    price: precioPublico,
    url: canonical,
  },
};

const breadcrumbJsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "Inicio",
      item: SITE_URL ? `${SITE_URL}/` : "/",
    },
    {
      "@type": "ListItem",
      position: 2,
      name: "Cat√°logo",
      item: SITE_URL ? `${SITE_URL}/catalogo` : "/catalogo",
    },
    {
      "@type": "ListItem",
      position: 3,
      name: producto.data.nombre,
      item: canonical,
    },
  ],
};
---

<BaseLayout title={title} description={description} ogImage={image}>

  <script type="application/ld+json">
    {JSON.stringify(productJsonLd)}
  </script>

  <script type="application/ld+json">
    {JSON.stringify(breadcrumbJsonLd)}
  </script>

  <style>
    .grid {
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 30px;
      align-items: start;
    }

    .image-box {
      border: 1px solid #eee;
      border-radius: 18px;
      overflow: hidden;
      background: #f6f6f6;
    }

    .info-box {
      border: 1px solid #eee;
      border-radius: 18px;
      padding: 20px;
      background: #fff;
    }

    .price {
      font-size: 24px;
      font-weight: 900;
      margin-bottom: 10px;
    }

    @media (max-width: 820px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <div class="grid">

    <!-- Imagen -->
    <div class="image-box">
      {producto.data.imagen && (
        <img
          src={producto.data.imagen}
          alt={producto.data.nombre}
          style="width:100%;height:100%;object-fit:cover;"
        />
      )}
    </div>

    <!-- Info -->
    <div class="info-box">

      <div style="color:#666;font-size:13px;margin-bottom:8px;">
        {producto.data.marca} ‚Ä¢ {producto.data.categoria}
      </div>

      <h1 style="margin:0 0 12px;">
        {producto.data.nombre}
      </h1>

      {precioPublico > 0 ? (
        <div class="price">
          Gs. {formatGs(precioPublico)}
          <span style="font-size:13px;color:#666;font-weight:600;">
            {" / "}
            {producto.data.tipoVenta === "metro" ? "metro" : "unidad"}
          </span>
        </div>
      ) : (
        <div class="price" style="color:#999;">
          Consultar precio
        </div>
      )}

      <div style="margin-bottom:20px;color:#444;">
        {producto.data.descripcionCorta}
      </div>

      {precioPublico > 0 && (
        <AddToOrderButton
          client:load
          slug={producto.slug}
          nombre={producto.data.nombre}
          precioPublico={precioPublico}
          tipoVenta={producto.data.tipoVenta}
        />
      )}

      <div style="margin-top:14px;font-size:13px;color:#666;">
        Entrega 24‚Äì48h en Asunci√≥n y Central.
      </div>

    </div>

  </div>

  <!-- Descripci√≥n larga -->
  <section style="margin-top:30px;border:1px solid #eee;border-radius:18px;padding:20px;">
    <h2>Detalles</h2>
    <div set:html={producto.body} />
  </section>

  <div style="margin-top:20px;">
    <a href="/catalogo">‚Üê Volver al cat√°logo</a>
  </div>

</BaseLayout>
